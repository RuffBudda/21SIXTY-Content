name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e  # Exit immediately if any command fails
          cd /opt/content-generator
          
          # Ensure we're on main branch
          git checkout main 2>/dev/null || true
          
          # Fetch latest from GitHub
          git fetch origin main
          
          # Reset to match GitHub exactly (discard any local changes)
          git reset --hard origin/main
          
          # Clean up any untracked files
          git clean -fd
          
          echo "✅ Updated to commit: $(git log -1 --oneline)"
          
          # Update backend dependencies
          cd backend
          source venv/bin/activate
          pip install -r requirements.txt --upgrade --quiet
          
          # Restart the service
          sudo systemctl restart content-generator
          sudo systemctl status content-generator --no-pager -l
          
    - name: Verify deployment
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sleep 10
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts..."
            if curl -f http://localhost:8001/api/health; then
              echo "✅ Deployment verified successfully!"
              exit 0
            fi
            attempt=$((attempt + 1))
            sleep 2
          done
          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

