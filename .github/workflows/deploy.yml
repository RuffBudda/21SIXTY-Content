name: Deploy to DigitalOcean

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e  # Exit immediately if any command fails
          cd /opt/content-generator
          
          echo "========== GIT UPDATE =========="
          git checkout main 2>/dev/null || true
          git fetch origin main
          git reset --hard origin/main
          git clean -fd
          echo "✅ Updated to commit: $(git log -1 --oneline)"

          echo ""
          echo "========== NGINX CONFIG =========="
          if [ -f nginx/contents.2160.media.conf ]; then
            sudo cp nginx/contents.2160.media.conf /etc/nginx/sites-available/contents.2160.media
            sudo ln -sf /etc/nginx/sites-available/contents.2160.media /etc/nginx/sites-enabled/contents.2160.media
            sudo nginx -t
            sudo systemctl reload nginx
            echo "✅ Nginx config applied and reloaded"
            echo "Effective upload limit(s):"
            sudo nginx -T 2>/dev/null | grep -E "client_max_body_size|server_name contents\.2160\.media" || true
          else
            echo "⚠️ nginx/contents.2160.media.conf not found in repo, skipping nginx reload"
          fi
          
          echo ""
          echo "========== DEPENDENCY INSTALLATION =========="
          cd backend
          source venv/bin/activate
          
          # Show Python version
          echo "Python: $(python --version)"
          echo "Pip: $(pip --version)"
          
          # Install with verbose output to see errors
          echo "Installing requirements..."
          pip install -r requirements.txt --upgrade
          
          # List installed packages
          echo ""
          echo "========== INSTALLED PACKAGES =========="
          pip list | grep -E "sqlalchemy|aiosqlite|fastapi|uvicorn" || true
          
          # Test Python imports
          echo ""
          echo "========== TESTING IMPORTS =========="
          python3 << 'PYEOF'
          import sys
          print('Testing critical imports...')
          try:
              import fastapi
              print('✓ fastapi')
          except Exception as e:
              print('✗ fastapi:', e)
              sys.exit(1)
          try:
              from dotenv import load_dotenv
              print('✓ dotenv')
          except Exception as e:
              print('✗ dotenv:', e)
              sys.exit(1)
          try:
              import sqlalchemy
              print('✓ sqlalchemy')
          except Exception as e:
              print('✗ sqlalchemy:', e)
              sys.exit(1)
          try:
              import aiosqlite
              print('✓ aiosqlite')
          except Exception as e:
              print('✗ aiosqlite:', e)
              sys.exit(1)
          print('All imports successful!')
          PYEOF
          
          # Test main.py syntax
          echo ""
          echo "========== TESTING MAIN.PY SYNTAX =========="
          python -m py_compile main.py && echo "✓ main.py syntax OK" || exit 1
          
          # Check .env file
          echo ""
          echo "========== CHECKING .env =========="
          if [ -f .env ]; then
            echo "✓ .env file exists"
            echo "  MASTER_PASSWORD set: $(grep -q 'MASTER_PASSWORD=' .env && echo 'YES' || echo 'NO')"
          else
            echo "✗ .env file NOT FOUND"
            exit 1
          fi
          
          echo ""
          echo "========== RESTARTING SERVICE =========="
          sudo systemctl restart content-generator
          sleep 3
          
          # Check service status
          echo ""
          echo "========== SERVICE STATUS =========="
          sudo systemctl status content-generator --no-pager || true
          
          # Show recent logs
          echo ""
          echo "========== RECENT SERVICE LOGS =========="
          sudo journalctl -u content-generator -n 100 --no-pager || true
          
    - name: Verify deployment
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sleep 10
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt/$max_attempts..."
            if curl -f http://localhost:8001/api/health; then
              echo "✅ Deployment verified successfully!"
              exit 0
            fi
            attempt=$((attempt + 1))
            sleep 2
          done
          echo "❌ Health check failed after $max_attempts attempts"
          exit 1

